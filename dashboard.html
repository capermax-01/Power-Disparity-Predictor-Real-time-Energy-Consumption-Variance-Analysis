<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Disparity Predictor - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .status-indicator {
            display: inline-block;
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .status-indicator.inactive {
            background: #ff5722;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .result {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .result.high {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .result.medium {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .result.low {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }

        .result h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
        }

        .risk-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .risk-badge.high {
            background: #f44336;
            color: white;
        }

        .risk-badge.medium {
            background: #ff9800;
            color: white;
        }

        .risk-badge.low {
            background: #4caf50;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            color: #666;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            margin: 0;
            width: auto;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .batch-input {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px dashed #ddd;
        }

        .batch-result {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .batch-result.high {
            border-left-color: #f44336;
        }

        .batch-result.medium {
            border-left-color: #ff9800;
        }

        .batch-result.low {
            border-left-color: #4caf50;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .info-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .info-box h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .info-box p {
            color: #666;
            font-size: 0.9em;
        }

        .model-status {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .error-message {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 2em;
            }
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            header {
                padding: 20px;
            }

            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Power Disparity Predictor</h1>
            <p>Real-time Energy Consumption Variance Analysis</p>
            <div id="status" class="status-indicator">Connecting...</div>
        </header>

        <div class="main-grid">
            <!-- Single Prediction -->
            <div class="card">
                <h2>Single Prediction</h2>
                
                <div id="error-message" class="error-message"></div>
                <div id="model-status" class="model-status" style="display:none;">
                    <strong>‚úÖ Model Status:</strong> Ready for predictions
                </div>

                <form id="singleForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="appliance_id">Appliance ID *</label>
                            <input type="text" id="appliance_id" name="appliance_id" placeholder="e.g., fridge_207" required>
                        </div>
                        <div class="form-group">
                            <label for="appliance_category">Category *</label>
                            <select id="appliance_category" name="appliance_category" required>
                                <option value="">Select category</option>
                                <option value="kitchen">Kitchen</option>
                                <option value="multimedia">Multimedia</option>
                                <option value="washing">Washing</option>
                                <option value="cooling">Cooling</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="hour">Hour (0-23) *</label>
                            <input type="number" id="hour" name="hour" min="0" max="23" value="12" required>
                        </div>
                        <div class="form-group">
                            <label for="day_of_week">Day of Week (0-6) *</label>
                            <input type="number" id="day_of_week" name="day_of_week" min="0" max="6" value="3" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="power_reading">Current Power (W) *</label>
                            <input type="number" id="power_reading" name="power_reading" min="0" step="0.1" value="1000" required>
                        </div>
                        <div class="form-group">
                            <label for="power_max">Max Power (W) *</label>
                            <input type="number" id="power_max" name="power_max" min="0" step="0.1" value="1500" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="power_std_12h">12h Std Dev (W)</label>
                            <input type="number" id="power_std_12h" name="power_std_12h" min="0" step="0.1" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="power_mean_12h">12h Mean (W)</label>
                            <input type="number" id="power_mean_12h" name="power_mean_12h" min="0" step="0.1" value="950" required>
                        </div>
                    </div>

                    <button type="button" onclick="makePrediction()" class="predict-btn">
                        üîÆ Predict Disparity
                    </button>
                </form>

                <div id="singleResult"></div>
            </div>

            <!-- Model Information -->
            <div class="card">
                <h2>Model Information</h2>
                
                <div class="info-grid">
                    <div class="info-box">
                        <h4>Model Type</h4>
                        <p>Gradient Boosting Regressor</p>
                    </div>
                    <div class="info-box">
                        <h4>Accuracy</h4>
                        <p>95.09% R¬≤ Score</p>
                    </div>
                    <div class="info-box">
                        <h4>Features</h4>
                        <p>15 Engineering</p>
                    </div>
                </div>

                <h3 style="margin-top: 20px; color: #667eea;">Key Metrics</h3>
                
                <div class="metric">
                    <span class="metric-label">RMSE</span>
                    <span class="metric-value">31.48W</span>
                </div>
                <div class="metric">
                    <span class="metric-label">MAE</span>
                    <span class="metric-value">6.50W</span>
                </div>
                <div class="metric">
                    <span class="metric-label">R¬≤ Score</span>
                    <span class="metric-value">0.9509</span>
                </div>

                <h3 style="margin-top: 20px; color: #667eea;">What is Power Disparity?</h3>
                
                <p style="margin-top: 10px; line-height: 1.6; color: #666; font-size: 0.95em;">
                    Power disparity measures the unpredictability of energy consumption. Higher values indicate unstable power usage patterns, important for grid management and equipment planning.
                </p>

                <div style="background: #e3f2fd; padding: 12px; border-radius: 5px; margin-top: 15px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1565c0;">Risk Levels:</strong>
                    <ul style="margin-left: 20px; margin-top: 8px; font-size: 0.9em; color: #666;">
                        <li><strong style="color: #f44336;">HIGH:</strong> CV > 80% - Unstable</li>
                        <li><strong style="color: #ff9800;">MEDIUM:</strong> CV 40-80% - Moderate</li>
                        <li><strong style="color: #4caf50;">LOW:</strong> CV < 40% - Stable</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Bottom Section -->
        <div class="card">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('batch')">üìä Batch Predictions</button>
                <button class="tab-button" onclick="switchTab('api')">üîå API Reference</button>
            </div>

            <div id="batch" class="tab-content active">
                <h2>Batch Predictions</h2>
                
                <div class="batch-input">
                    <label for="batchJson">Paste JSON Array of Predictions:</label>
                    <textarea id="batchJson" rows="6" style="width:100%; padding:10px; border:2px solid #ddd; border-radius:5px; font-family:monospace; margin-top:10px;" placeholder='[{"hour": 12, "day_of_week": 3, "day_of_month": 15, "month": 3, "is_weekend": 0, "appliance_id": "fridge_207", "appliance_category": "kitchen", "power_reading": 1000, "power_max": 1500, "power_std_12h": 100, "power_mean_12h": 950}]'></textarea>
                </div>

                <button onclick="batchPredict()">üìà Process Batch</button>

                <div id="batchResult" style="margin-top: 20px;"></div>
            </div>

            <div id="api" class="tab-content">
                <h2>API Reference</h2>
                
                <h3 style="color: #667eea; margin-top: 15px;">Available Endpoints</h3>

                <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <strong>GET /health</strong> - Check API health<br>
                    <strong>GET /model/info</strong> - Get model information<br>
                    <strong>POST /predict</strong> - Single prediction<br>
                    <strong>POST /predict/batch</strong> - Batch predictions
                </div>

                <h3 style="color: #667eea; margin-top: 15px;">Example Request</h3>

                <pre style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>curl -X POST "http://localhost:8000/predict" \
  -H "Content-Type: application/json" \
  -d '{
    "hour": 12,
    "day_of_week": 3,
    "day_of_month": 15,
    "month": 3,
    "is_weekend": 0,
    "appliance_id": "fridge_207",
    "appliance_category": "kitchen",
    "power_reading": 1000,
    "power_max": 1500,
    "power_std_6h": 50,
    "power_mean_6h": 950,
    "power_std_12h": 100,
    "power_mean_12h": 950,
    "power_std_24h": 150,
    "power_mean_24h": 900
  }'</code></pre>

                <h3 style="color: #667eea; margin-top: 15px;">Response Format</h3>

                <pre style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>{
  "predicted_disparity_w": 125.45,
  "confidence": 92.50,
  "risk_level": "MEDIUM",
  "timestamp": "2026-02-06T12:00:00"
}</code></pre>
            </div>
        </div>
    </div>

    <script>
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            checkModelStatus();
            // Refresh status every 5 seconds
            setInterval(checkModelStatus, 5000);
        });

        // Check if model is ready
        function checkModelStatus() {
            fetch('http://localhost:8000/health')
                .then(r => r.json())
                .then(data => {
                    const status = document.getElementById('status');
                    const modelStatus = document.getElementById('model-status');
                    
                    if (data.ready_for_predictions) {
                        status.textContent = '‚úÖ Connected & Ready';
                        status.classList.remove('inactive');
                        modelStatus.style.display = 'block';
                    } else if (data.model_loaded) {
                        status.textContent = '‚è≥ Model Loading...';
                        status.classList.add('inactive');
                    } else {
                        status.textContent = '‚ùå Model Not Ready';
                        status.classList.add('inactive');
                        showError('Model not loaded. Please train the model first.');
                    }
                })
                .catch(() => {
                    document.getElementById('status').textContent = '‚ùå Server Offline';
                    document.getElementById('status').classList.add('inactive');
                    showError('Cannot connect to server. Make sure serve_model.py is running.');
                });
        }

        // Make single prediction
        async function makePrediction() {
            const btn = document.querySelector('.predict-btn');
            btn.disabled = true;
            
            const loading = document.createElement('div');
            loading.className = 'loading show';
            loading.innerHTML = '<div class="spinner"></div>Analyzing...';
            document.getElementById('singleResult').innerHTML = '';
            document.getElementById('singleResult').appendChild(loading);

            try {
                const formData = {
                    hour: parseInt(document.getElementById('hour').value),
                    day_of_week: parseInt(document.getElementById('day_of_week').value),
                    day_of_month: parseInt(document.getElementById('day_of_month').value),
                    month: parseInt(document.getElementById('month').value || new Date().getMonth() + 1),
                    is_weekend: parseInt(document.getElementById('day_of_week').value) >= 5 ? 1 : 0,
                    appliance_id: document.getElementById('appliance_id').value,
                    appliance_category: document.getElementById('appliance_category').value,
                    power_reading: parseFloat(document.getElementById('power_reading').value),
                    power_max: parseFloat(document.getElementById('power_max').value),
                    power_std_6h: parseFloat(document.getElementById('power_std_12h').value) || 0,
                    power_mean_6h: parseFloat(document.getElementById('power_mean_12h').value) || 0,
                    power_std_12h: parseFloat(document.getElementById('power_std_12h').value) || 0,
                    power_mean_12h: parseFloat(document.getElementById('power_mean_12h').value) || 0,
                    power_std_24h: parseFloat(document.getElementById('power_std_12h').value) * 1.2 || 0,
                    power_mean_24h: parseFloat(document.getElementById('power_mean_12h').value) * 0.95 || 0
                };

                const response = await fetch('http://localhost:8000/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('Prediction failed');

                const data = await response.json();

                const resultHTML = `
                    <div class="result ${data.risk_level.toLowerCase()}">
                        <h3>Prediction Results</h3>
                        <div class="metric">
                            <span class="metric-label">Predicted Disparity</span>
                            <span class="metric-value">${data.predicted_disparity_w} W</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Confidence</span>
                            <span class="metric-value">${data.confidence}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Risk Level</span>
                            <span class="risk-badge ${data.risk_level.toLowerCase()}">${data.risk_level}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Analysis Time</span>
                            <span class="metric-value">${new Date(data.timestamp).toLocaleTimeString()}</span>
                        </div>
                    </div>
                `;

                document.getElementById('singleResult').innerHTML = resultHTML;
            } catch (error) {
                showError('Error making prediction: ' + error.message);
            } finally {
                btn.disabled = false;
            }
        }

        // Batch prediction
        async function batchPredict() {
            try {
                const jsonText = document.getElementById('batchJson').value;
                const predictions = JSON.parse(jsonText);

                if (!Array.isArray(predictions)) {
                    showError('Invalid JSON: must be an array');
                    return;
                }

                const response = await fetch('http://localhost:8000/predict/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ predictions })
                });

                if (!response.ok) throw new Error('Batch prediction failed');

                const data = await response.json();

                let resultHTML = `<h3>Results (${data.count} predictions)</h3>`;
                
                data.predictions.forEach((pred, i) => {
                    resultHTML += `
                        <div class="batch-result ${pred.risk_level.toLowerCase()}">
                            <strong>${pred.appliance_id}</strong>
                            <div style="margin-top: 8px;">
                                <div><strong>Disparity:</strong> ${pred.predicted_disparity_w} W</div>
                                <div><strong>Confidence:</strong> ${pred.confidence}%</div>
                                <span class="risk-badge ${pred.risk_level.toLowerCase()}">${pred.risk_level}</span>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('batchResult').innerHTML = resultHTML;
            } catch (error) {
                showError('Error in batch prediction: ' + error.message);
            }
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        // Error display
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }
    </script>
</body>
</html>
